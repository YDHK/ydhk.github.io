<!DOCTYPE html>
<html>

    <head>
        <title>2048</title>
        <meta charset="utf-8" />
        <script typet="text/javascript" src="http://code.jquery.com/jquery-latest.js"></script>
        <style>
            canvas {
                display: block;
                margin: 0 auto;
                border-radius: 10px;
                background-color: #bbada0;
            }
        .auto-style1 {
	text-align: center;
}
.auto-style2 {
	text-align: center;
	font-family: Arial, Helvetica, sans-serif;
	font-size: medium;
}
.auto-style3 {
	font-family: Arial, Helvetica, sans-serif;
}
.auto-style4 {
	text-align: center;
	font-family: Arial, Helvetica, sans-serif;
	font-size: large;
}
        </style>
    </head>

    <body>
    	<body style="background-color:orange;">
        <center id="score" style="font:bold 25px Arial,Microsoft Yahei">2048</center><br/>
        <canvas id="mycanvas" width="500" height="500"></canvas><span class="auto-style3">
		</span>
    	<p class="auto-style2">&nbsp;</p>
		<p class="auto-style4">2048</p>
		<p class="auto-style2">Move the blocks with the arrow keys and try to 
		reach 2048!</p>
		<p class="auto-style1">&nbsp;</p>
		<p class="auto-style1">&nbsp;</p>
		<p class="auto-style1">&nbsp;</p>
		<p class="auto-style1">&nbsp;</p>
    </body>
    <script>
        var canvas = document.getElementById("mycanvas");
        var ctx = canvas.getContext('2d');
        //é’æ¿†&#59216;é–æ §æ¹´é¥?
        var map = [
            [0, 0, 0, 0],
            [0, 0, 0, 0],
            [0, 0, 0, 0],
            [0, 0, 0, 0]
        ];
        //æ¶“å¶…æ‚“éæ¿ç“§é¨å‹¯&#58753;é‘¹è¹­ä¿Šé­?
        var num_color = {
            0: "#ccc0b3",
            2: "#eee4da",
            4: "#ede0c8",
            8: "#f2b179",
            16: "#f59563",
            32: "#f67c5f",
            64: "#ec6544",
            128: "#e44d29",
            256: "#edcf72",
            512: "#c8a145",
            1024: "#a8832b",
            2048: "#86aa9c"
        };
        //æ¶“å¶…æ‚“éæ¿ç“§é¨å‹«ã‡çå¿ä¿Šé?       
        var num_size = {
            0: "60",
            2: "60",
            4: "60",
            8: "60",
            16: "60",
            32: "60",
            64: "60",
            128: "50",
            256: "50",
            512: "50",
            1024: "40",
            2048: "40"
        };
        //æ¶“å¶…æ‚“éæ¿ç“§é¨å‹«äº¸ç»‰å©šå™ºé”›å œè´Ÿæµœå——çš¢éæ¿ç“§é¢è¯²æ¹ªé‚ç‘°æ½¡æ¶“&#57694;ç¸¾é”›?       
        var offsetx = {
            0: 53,
            2: 53,
            4: 53,
            8: 53,
            16: 34,
            32: 35,
            64: 35,
            128: 28,
            256: 28,
            512: 28,
            1024: 24,
            2048: 25
        };
        //æ¶“å©ç¬…å&#57743;ï¹€å½¸é–¿&#57790;æ®‘codeç€µç‘°ç°²é¨å‹&#57601;ŸŸéšæˆœä¿Šé­?       
        var keycom = {
            '38': [0, -1],
            '40': [0, 1],
            '37': [-1, 0],
            '39': [1, 0]
        }
        //spaceç›ã„§ãšè¤°æ’³å&#58757;é“â•€ç¶‘é¨å‹&#57691;”–éç…æ½¡éå¸&#57790;´scoreç›ã„§ãšè¤°æ’³å&#58757;é¨å‹«åé?
        var space = 16,
            score = 0;

        function formap(func) {
            for(var i = 0; i < 4; i++)
                for(var j = 0; j < 4; j++) {
                    func(i, j);
                }
        }

        function produce() {
            var cot = ~~(Math.random() * space);
            var k = 0;
            formap(function(i, j) {
                if(map[i][j] == 0) {
                    if(cot == k) {
                        map[i][j] = 2;
                        draw();
                    }
                    k += 1;
                }
            });
            space -= 1;
        }

        function draw() {
            formap(function(i, j) {
                var num = map[i][j];
                ctx.fillStyle = num_color[num];
                ctx.fillRect(j * 120 + 20, i * 120 + 20, 100, 100);
                if(num != 0) {
                    ctx.font = "bold " + num_size[num] + "px Arial,Microsoft Yahei";
                    ctx.fillStyle = (num <= 4) ? "#776e65" : "white";
                    ctx.fillText(String(map[i][j]), j * 120 + offsetx[num], i * 120 + 70 + num_size[num] / 3);
                }
            });
            document.getElementById("score").innerText = "Score: " + String(score);
        }

        function move(dir) {
            //é&#59244;„¦æ½µç’‹å†©æš£æ¶“å¶…æ‚“é‚ç‘°æ‚œé¨å‹¯äº¶é˜å—˜æŸŸå¯?
            function modify(x, y) {
                tx = x, ty = y;
                if(dir[0] == 0) tx = [ty, ty = tx][0];
                if(dir[1] > 0) tx = 3 - tx;
                if(dir[0] > 0) ty = 3 - ty;
                return [tx, ty];
            }
            //éè&#59209;åµç»‰è¯²å§©é¨å‹¬æŸŸéšæˆ&#57884;´çå——æ¹´é¥å¥è…‘ç€µç‘°ç°²ç›?é’æ¤¾è…‘é¨å‹&#57601;šŸç€›æ¤¾ç«´æ¶“&#57411;é‡œé˜å¬&#57412;†éå œè…‘é”›å±?#59111;é‹æ»…&#57543;æ¶“â‚¬å¨†ï¿ äº£é’ç‰ˆçˆ¤æ¤¤èˆµæšŸç€›æ&#59013;æ‹°å&#57829;å‘&#57694;†éå ŸæšŸç€›æ&#59016;æµ‰ç»›å¤›ç´é’æ¬çˆ¤æ¤¤èˆµæšŸç€›æ¤¾ç®?é”›å±¾æ¸¶éšåº£æ•¤éå œè…‘éæ¿ç“§é‡å­˜æŸŠé¦æ¿æµ˜æ¶?#57696;æ®‘ç€µç‘°ç°²ç›?é?
            for(var i = 0; i < 4; i++) {
                var tmp = Array();
                var isadd = false;
                for(var j = 0; j < 4; j++) {
                    var ti = modify(i, j)[0],
                        tj = modify(i, j)[1];
                    if(map[ti][tj] != 0) {
                        if(!isadd && map[ti][tj] == tmp[tmp.length - 1]) score += (tmp[tmp.length - 1] *= 2), isadd = true, space += 1;
                        else tmp.push(map[ti][tj]);
                    }
                }
                for(var j = 0; j < 4; j++) {
                    var ti = modify(i, j)[0],
                        tj = modify(i, j)[1];
                    map[ti][tj] = isNaN(tmp[j]) ? 0 : tmp[j];
                }
            }
            produce();
            if(space == 0) alert("game over" + String(score));
            draw();
        }
        produce();
        produce();
        document.onkeydown = function(e) {
            dir = keycom[(e ? e : event).keyCode];
            move(dir);
        };
        var sx, sy, dx, dy, ex, ey;
        canvas.ontouchstart = function(event) {
            var touch = event.touches[0];
            sx = touch.clientX, sy = touch.clientY;
        }
        canvas.ontouchmove = function(event) {
            var touch = event.touches[0];
            ex = touch.clientX, ey = touch.clientY;
            dx = ex - sx, dy = ey - sy;
            //ç»‚ä½¹&#57627;æ¦›æ&#59336;&#57723;é¨å‹¬ç²¦é”ã„¤ç°¨æµ?
            event.preventDefault();
        }
        canvas.ontouchend = function(event) {
            //éè&#59209;åµå¦¯&#57414;æ—±é§æ„&#57696;ˆ£æµ£å¶‡Ğ©é’ã‚†æŸ‡å&#59368;æˆå§©é‚ç‘°æ‚?
            if(dy < -50 && Math.abs(dy / dx) > 2) move([0, -1]);
            if(dy > 50 && Math.abs(dy / dx) > 2) move([0, 1]);
            if(dx < -50 && Math.abs(dx / dy) > 2) move([-1, 0]);
            if(dx > 50 && Math.abs(dx / dy) > 2) move([1, 0]);
        }
    </script>

</html>